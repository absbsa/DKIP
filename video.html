<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>视频观看监控</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #video-container { position: relative; width: 800px; height: 450px; }
    #overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      color: #fff; display: flex;
      align-items: center; justify-content: center;
      cursor: pointer; font-size: 20px;
      z-index: 2;
    }
    #inactive-msg { color: red; font-weight: bold; display: none; }
    #history { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>视频观看监控 Demo</h2>

  <!-- 视频选择 -->
  <label for="videoSelector">选择视频：</label>
  <select id="videoSelector">
    <option value="https://mivalyo.com/embed/6suaa9gg9y7y">视频1</option>
    <option value="https://mivalyo.com/embed/abcd1234efgh5678">视频2</option>
  </select>

  <!-- 视频区域 -->
  <div id="video-container">
    <iframe id="videoFrame" src="" width="800" height="450" frameborder="0" allowfullscreen></iframe>
    <div id="overlay">点击开始观看</div>
  </div>

  <p id="inactive-msg">⚠️ 您已不活跃，计时暂停！</p>
  <div id="history">观看记录：暂无</div>

  <script>
    // ================== 配置 ==================
    const REQUIRED_SECONDS = 120;      // 合格所需秒数
    const MAX_DAILY_WATCHES = 2;       // 每日最多次数
    const INACTIVE_TIMEOUT = 10;       // 无操作多少秒判定不活跃

    // ================== 全局状态 ==================
    let active = false;
    let currentSeconds = 0;
    let timer = null;
    let inactivityTimer = null;
    let currentVideo = "";
    const records = {}; // { videoUrl: { name, seconds, qualified } }

    // ================== 工具函数 ==================
    function getIP() {
      return new Promise(resolve => {
        fetch("https://api64.ipify.org?format=json")
          .then(res => res.json())
          .then(data => resolve(data.ip))
          .catch(() => resolve("unknown"));
      });
    }

    function getTodayKey(ip) {
      const today = new Date().toISOString().slice(0,10);
      return `watch_${ip}_${today}`;
    }

    async function canWatch() {
      const ip = await getIP();
      const key = getTodayKey(ip);
      let count = localStorage.getItem(key) || 0;
      return { allowed: count < MAX_DAILY_WATCHES, key, count };
    }

    function addWatch(key, count) {
      localStorage.setItem(key, count+1);
    }

    function sendGAEvent(videoUrl, seconds) {
      console.log("📊 发送 GA 事件:", videoUrl, seconds);
      // TODO: 替换成你自己的 GA 上报
    }

    // ================== 活跃监控 ==================
    function resetActivity() {
      active = true;
      document.getElementById("inactive-msg").style.display = "none";
      if (inactivityTimer) clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        active = false;
        document.getElementById("inactive-msg").style.display = "block";
      }, INACTIVE_TIMEOUT * 1000);
    }

    document.addEventListener("mousemove", resetActivity);
    document.addEventListener("click", resetActivity);

    // ================== 计时逻辑 ==================
    function startTimer() {
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        if (active) {
          currentSeconds++;
          console.log(`⏱ 当前已观看 ${currentSeconds} 秒`);

          // 更新记录
          if (records[currentVideo]) {
            records[currentVideo].seconds = currentSeconds;
          }

          // 判断合格
          if (currentSeconds >= REQUIRED_SECONDS && !records[currentVideo].qualified) {
            records[currentVideo].qualified = true;
            sendGAEvent(currentVideo, currentSeconds);
          }

          updateHistory();
        }
      }, 1000);
    }

    function stopTimer() {
      if (timer) clearInterval(timer);
      timer = null;
    }

    // ================== 界面更新 ==================
    function updateHistory() {
      let html = "观看记录：<br>";
      let hasRecord = false;
      Object.values(records).forEach(item => {
        hasRecord = true;
        const status = item.qualified ? "✅ 合格" : "⏳ 进行中";
        html += `${item.name}: 已观看 ${item.seconds} 秒 ${status}<br>`;
      });
      if (!hasRecord) html += "暂无";
      document.getElementById("history").innerHTML = html;
    }

    // ================== 事件绑定 ==================
    document.getElementById("overlay").addEventListener("click", async () => {
      const { allowed, key, count } = await canWatch();
      if (!allowed) {
        alert("今日观看次数已达上限！");
        return;
      }
      addWatch(key, parseInt(count));
      document.getElementById("overlay").style.display = "none";
      resetActivity();
      startTimer();
    });

    document.getElementById("videoSelector").addEventListener("change", e => {
      const url = e.target.value;
      currentVideo = url;
      document.getElementById("videoFrame").src = url;

      if (!records[url]) {
        records[url] = { name: e.target.selectedOptions[0].text, seconds: 0, qualified: false };
      }
      currentSeconds = records[url].seconds;
      updateHistory();

      // 切换视频时重置覆盖层
      document.getElementById("overlay").style.display = "flex";
      stopTimer();
    });

    // 初始化加载第一个视频
    document.getElementById("videoSelector").dispatchEvent(new Event("change"));
  </script>
</body>
</html>
