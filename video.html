<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>è§†é¢‘è§‚çœ‹ç›‘æ§</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #video-container { position: relative; width: 800px; height: 450px; }
    #overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      color: #fff; display: flex;
      align-items: center; justify-content: center;
      cursor: pointer; font-size: 20px;
      z-index: 2;
    }
    #inactive-msg { color: red; font-weight: bold; display: none; }
    #history { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>è§†é¢‘è§‚çœ‹ç›‘æ§ Demo</h2>

  <!-- è§†é¢‘é€‰æ‹© -->
  <label for="videoSelector">é€‰æ‹©è§†é¢‘ï¼š</label>
  <select id="videoSelector">
    <option value="https://mivalyo.com/embed/6suaa9gg9y7y">è§†é¢‘1</option>
    <option value="https://mivalyo.com/embed/abcd1234efgh5678">è§†é¢‘2</option>
  </select>

  <!-- è§†é¢‘åŒºåŸŸ -->
  <div id="video-container">
    <iframe id="videoFrame" src="" width="800" height="450" frameborder="0" allowfullscreen></iframe>
    <div id="overlay">ç‚¹å‡»å¼€å§‹è§‚çœ‹</div>
  </div>

  <p id="inactive-msg">âš ï¸ æ‚¨å·²ä¸æ´»è·ƒï¼Œè®¡æ—¶æš‚åœï¼</p>
  <div id="history">è§‚çœ‹è®°å½•ï¼šæš‚æ— </div>

  <script>
    // ================== é…ç½® ==================
    const REQUIRED_SECONDS = 120;      // åˆæ ¼æ‰€éœ€ç§’æ•°
    const MAX_DAILY_WATCHES = 2;       // æ¯æ—¥æœ€å¤šæ¬¡æ•°
    const INACTIVE_TIMEOUT = 10;       // æ— æ“ä½œå¤šå°‘ç§’åˆ¤å®šä¸æ´»è·ƒ

    // ================== å…¨å±€çŠ¶æ€ ==================
    let active = false;
    let currentSeconds = 0;
    let timer = null;
    let inactivityTimer = null;
    let currentVideo = "";
    const records = {}; // { videoUrl: { name, seconds, qualified } }

    // ================== å·¥å…·å‡½æ•° ==================
    function getIP() {
      return new Promise(resolve => {
        fetch("https://api64.ipify.org?format=json")
          .then(res => res.json())
          .then(data => resolve(data.ip))
          .catch(() => resolve("unknown"));
      });
    }

    function getTodayKey(ip) {
      const today = new Date().toISOString().slice(0,10);
      return `watch_${ip}_${today}`;
    }

    async function canWatch() {
      const ip = await getIP();
      const key = getTodayKey(ip);
      let count = localStorage.getItem(key) || 0;
      return { allowed: count < MAX_DAILY_WATCHES, key, count };
    }

    function addWatch(key, count) {
      localStorage.setItem(key, count+1);
    }

    function sendGAEvent(videoUrl, seconds) {
      console.log("ğŸ“Š å‘é€ GA äº‹ä»¶:", videoUrl, seconds);
      // TODO: æ›¿æ¢æˆä½ è‡ªå·±çš„ GA ä¸ŠæŠ¥
    }

    // ================== æ´»è·ƒç›‘æ§ ==================
    function resetActivity() {
      active = true;
      document.getElementById("inactive-msg").style.display = "none";
      if (inactivityTimer) clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        active = false;
        document.getElementById("inactive-msg").style.display = "block";
      }, INACTIVE_TIMEOUT * 1000);
    }

    document.addEventListener("mousemove", resetActivity);
    document.addEventListener("click", resetActivity);

    // ================== è®¡æ—¶é€»è¾‘ ==================
    function startTimer() {
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        if (active) {
          currentSeconds++;
          console.log(`â± å½“å‰å·²è§‚çœ‹ ${currentSeconds} ç§’`);

          // æ›´æ–°è®°å½•
          if (records[currentVideo]) {
            records[currentVideo].seconds = currentSeconds;
          }

          // åˆ¤æ–­åˆæ ¼
          if (currentSeconds >= REQUIRED_SECONDS && !records[currentVideo].qualified) {
            records[currentVideo].qualified = true;
            sendGAEvent(currentVideo, currentSeconds);
          }

          updateHistory();
        }
      }, 1000);
    }

    function stopTimer() {
      if (timer) clearInterval(timer);
      timer = null;
    }

    // ================== ç•Œé¢æ›´æ–° ==================
    function updateHistory() {
      let html = "è§‚çœ‹è®°å½•ï¼š<br>";
      let hasRecord = false;
      Object.values(records).forEach(item => {
        hasRecord = true;
        const status = item.qualified ? "âœ… åˆæ ¼" : "â³ è¿›è¡Œä¸­";
        html += `${item.name}: å·²è§‚çœ‹ ${item.seconds} ç§’ ${status}<br>`;
      });
      if (!hasRecord) html += "æš‚æ— ";
      document.getElementById("history").innerHTML = html;
    }

    // ================== äº‹ä»¶ç»‘å®š ==================
    document.getElementById("overlay").addEventListener("click", async () => {
      const { allowed, key, count } = await canWatch();
      if (!allowed) {
        alert("ä»Šæ—¥è§‚çœ‹æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼");
        return;
      }
      addWatch(key, parseInt(count));
      document.getElementById("overlay").style.display = "none";
      resetActivity();
      startTimer();
    });

    document.getElementById("videoSelector").addEventListener("change", e => {
      const url = e.target.value;
      currentVideo = url;
      document.getElementById("videoFrame").src = url;

      if (!records[url]) {
        records[url] = { name: e.target.selectedOptions[0].text, seconds: 0, qualified: false };
      }
      currentSeconds = records[url].seconds;
      updateHistory();

      // åˆ‡æ¢è§†é¢‘æ—¶é‡ç½®è¦†ç›–å±‚
      document.getElementById("overlay").style.display = "flex";
      stopTimer();
    });

    // åˆå§‹åŒ–åŠ è½½ç¬¬ä¸€ä¸ªè§†é¢‘
    document.getElementById("videoSelector").dispatchEvent(new Event("change"));
  </script>
</body>
</html>
