<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>视频任务简化版</title>
  <style>
    body {
      background: #222;
      color: #fff;
      text-align: center;
      padding: 50px;
      font-family: "微软雅黑", sans-serif;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    h2 {
      margin-bottom: 20px;
    }
    .rule {
      text-align: left;
      margin: 20px 0;
      line-height: 1.6;
      color: #ffd700;
    }
    button {
      padding: 12px 30px;
      border-radius: 25px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      background: #1da1f2;
      color: #fff;
      transition: 0.3s;
      margin-top: 20px;
    }
    button:hover {
      background: #0d8bd9;
    }
    .status {
      margin: 20px 0;
      font-size: 16px;
      min-height: 30px;
    }
    .ip-alert {
      color: #ff4444;
      margin-top: 10px;
    }
    video {
      width: 100%;
      height: auto;
      margin-top: 30px;
      display: none;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>选择视频</h2>
    <div class="rule">
      点击视频开始按钮，连续点击直至无广告弹出，不能屏蔽广告，弹出后不管<br>
      如点击开始后无广告，连续点击页面直至看到视频进度条<br>
      每个视频需观看满 <span style="color: #4caf50;">120 秒</span> 才算合格
    </div>
    <button onclick="startTask()">开始观看</button>
    <div class="status" id="statusText">等待操作...</div>
    <div class="ip-alert" id="ipAlert"></div>
    <!-- 真实视频容器 -->
    <video id="videoPlayer" controls>
      <source src="https://mivalyo.com/embed/6suaa9gg9y7y" type="video/mp4">
    </video>
  </div>

  <script>
    // 核心变量
    let timer = null;       // 计时定时器
    let watchSeconds = 0;   // 已观看时长
    let isTracking = false; // 是否计时中
    let ipCount = 0;        // IP当日使用次数
    const DAILY_LIMIT = 2;  // 每日限制次数
    const video = document.getElementById('videoPlayer');

    // 获取IP（国内轻量API）
    async function getIp() {
      try {
        const res = await fetch('https://api.ip.sb/jsonip');
        return (await res.json()).ip;
      } catch (err) {
        return 'unknown';
      }
    }

    // 检查IP使用次数（本地存储）
    function checkIpUsage() {
      const data = localStorage.getItem('videoTaskIp') || '{"count":0,"reset":0}';
      const { count, reset } = JSON.parse(data);
      const now = Date.now();
      if (now - reset > 24 * 60 * 60 * 1000) {
        localStorage.setItem('videoTaskIp', JSON.stringify({ count: 0, reset: now }));
        return 0;
      }
      return count;
    }

    // 启动任务（开始观看流程）
    async function startTask() {
      // 1. 检查IP限制
      ipCount = checkIpUsage();
      if (ipCount >= DAILY_LIMIT) {
        document.getElementById('ipAlert').innerText = `24小时内仅能使用${DAILY_LIMIT}次，已用完`;
        return;
      }

      // 2. 显示状态，加载视频
      document.getElementById('statusText').innerText = '视频加载中...';
      document.getElementById('ipAlert').innerText = '';
      video.style.display = 'block';
      video.load(); // 触发加载

      // 3. 视频播放后启动计时
      video.addEventListener('play', startTimer);
    }

    // 视频播放时启动计时
    function startTimer() {
      if (isTracking) return;
      isTracking = true;
      document.getElementById('statusText').innerText = '正在计时...';
      timer = setInterval(() => {
        watchSeconds++;
        if (watchSeconds >= 120) {
          clearInterval(timer);
          document.getElementById('statusText').innerText = '已达标！观看满120秒';
          // 增加IP次数
          localStorage.setItem('videoTaskIp', JSON.stringify({
            count: ipCount + 1,
            reset: JSON.parse(localStorage.getItem('videoTaskIp')).reset
          }));
        }
      }, 1000);
    }

    // 页面关闭清理
    window.addEventListener('beforeunload', () => {
      clearInterval(timer);
      console.log(`最终观看时长：${watchSeconds}秒`);
    });

    // 初始化IP检查
    (async () => {
      const ip = await getIp();
      ipCount = checkIpUsage();
      if (ipCount >= DAILY_LIMIT) {
        document.getElementById('ipAlert').innerText = `当前IP(${ip})今日已用${ipCount}次，超限`;
      }
    })();
  </script>
</body>
</html>
