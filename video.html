<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X0ZSRRF93P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-X0ZSRRF93P');
  </script>

  <style>
    body {
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .video-container {
      width: 100%;
      height: 70vh;
      margin-top: 20px;
      display: none;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .video-selector {
      margin: 20px 0;
      padding: 20px;
      background: #222;
      border-radius: 10px;
      text-align: center;
    }
    button {
      padding: 12px 24px;
      background: #1DA1F2;
      color: white;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #0d8bd9;
    }
    .rule-note {
      font-size: 14px;
      color: #ffd700;
      margin-top: 5px;
      line-height: 1.6; /* 增加行高，提高长文本可读性 */
      white-space: pre-line; /* 保留换行符 */
    }
    .duration-alert {
      color: #4CAF50;
      margin-top: 10px;
      display: none;
    }
    .progress-display {
      color: #fff;
      margin-top: 10px;
      font-size: 14px;
    }
    .video-history {
      margin-top: 15px;
      padding: 10px;
      background: #333;
      border-radius: 5px;
      font-size: 13px;
      text-align: left;
    }
    .ip-reminder {
      color: #ff9800;
      margin-top: 10px;
      font-size: 14px;
      display: none;
    }
    .ip-limit-alert {
      color: #ff4444;
      margin-top: 10px;
      font-size: 14px;
      display: none;
    }
    .manual-start提示 {
      color: #ff4444;
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 视频选择器 -->
    <div class="video-selector">
      <h3>选择视频</h3>
      <select id="videoSelector">
        <option value="https://mivalyo.com/embed/6suaa9gg9y7y" data-id="video1">黄霄雲 1</option>
        <option value="https://mivalyo.com/embed/649eym1t2485" data-id="video2">黄霄雲 2</option>
        <option value="https://mivalyo.com/embed/third-video-id" data-id="video3">视频 3</option>
      </select>
      <p class="rule-note">点击视频开始按钮，连续点击直至无广告弹出，不能屏蔽广告，弹出后不管，看完视频后关闭浏览器，如点击开始后视频直接播放未弹出广告，连续点击播放视频页面直至能看到视频进度条为止，每个视频观看满 120 秒才算合格</p>
      <button onclick="startWatching()">开始观看</button>
      
      <!-- 手动开始计时按钮（备用） -->
      <button onclick="manualStartTracking()" style="background:#ff4444; margin-left:10px;">
        手动开始计时
      </button>
      
      <!-- IP使用次数提醒 -->
      <p class="ip-reminder" id="ipReminder"></p>
      <p class="ip-limit-alert" id="ipLimitAlert"></p>
      
      <!-- 视频历史记录显示 -->
      <div class="video-history" id="videoHistory">
        观看记录：暂无
      </div>
    </div>

    <!-- 视频容器 -->
    <div class="video-container" id="videoContainer">
      <p class="progress-display" id="progressDisplay">等待视频播放中...</p>
      <p class="duration-alert" id="durationAlert">已达到有效观看时长（120秒）</p>
      <p class="manual-start提示" id="manualHint" style="display:none;">
        系统未检测到视频播放，可点击"手动开始计时"
      </p>
      <iframe id="videoFrame" allowfullscreen></iframe>
    </div>
  </div>

  <script>
    let timer = null;
    let playCheckInterval = null; // 播放状态检测的定时器
    let lastKnownTime = 0; // 上次检测的时间点
    let timeProgressCount = 0; // 连续检测到时间推进的次数
    let currentVideoId = '';
    let currentVideoUrl = '';
    let userIp = '';
    let isVideoPlaying = false; // 标记视频是否正在播放
    let isWithinLimit = true; // 是否在24小时限制内
    const REQUIRED_SECONDS = 120; // 固定120秒合格
    const IP_USAGE_KEY = 'ipDailyUsageCount'; // 存储IP每日使用次数的localStorage键名
    const DAILY_LIMIT = 2; // 24小时内最大使用次数
    
    // 用对象存储每个视频的独立记录（键为videoId）
    let videoRecords = {};

    // 获取用户IP
    async function getIp() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        console.error('获取IP失败:', error);
        return 'unknown-ip';
      }
    }

    // 检查是否超过24小时，重置计数
    function checkAndResetDailyCount(ipData) {
      const now = new Date().getTime();
      const oneDay = 24 * 60 * 60 * 1000; // 24小时毫秒数
      
      // 如果超过24小时或首次记录，重置计数
      if (!ipData.lastReset || now - ipData.lastReset > oneDay) {
        ipData.count = 0;
        ipData.lastReset = now;
      }
      return ipData;
    }

    // 记录并获取当前IP的当日使用次数
    function getIpUsageCount() {
      const now = new Date().getTime();
      const ipDataStr = localStorage.getItem(IP_USAGE_KEY) || '{}';
      let ipData = JSON.parse(ipDataStr);

      // 初始化当前IP的记录（如果不存在）
      if (!ipData[userIp]) {
        ipData[userIp] = { count: 0, lastReset: now };
      }
      
      // 检查是否需要重置每日计数
      ipData[userIp] = checkAndResetDailyCount(ipData[userIp]);
      localStorage.setItem(IP_USAGE_KEY, JSON.stringify(ipData));
      
      return ipData[userIp].count;
    }

    // 递增IP使用次数并显示提醒
    function incrementIpUsage() {
      const now = new Date().getTime();
      const ipDataStr = localStorage.getItem(IP_USAGE_KEY) || '{}';
      let ipData = JSON.parse(ipDataStr);

      // 初始化当前IP的记录（如果不存在）
      if (!ipData[userIp]) {
        ipData[userIp] = { count: 0, lastReset: now };
      }
      
      // 检查是否需要重置每日计数
      ipData[userIp] = checkAndResetDailyCount(ipData[userIp]);
      
      // 递增计数
      ipData[userIp].count++;
      localStorage.setItem(IP_USAGE_KEY, JSON.stringify(ipData));
      
      const currentCount = ipData[userIp].count;
      // 判断是否超过限制
      isWithinLimit = currentCount <= DAILY_LIMIT;
      
      // 显示相应提示
      const reminderEl = document.getElementById('ipReminder');
      const limitAlertEl = document.getElementById('ipLimitAlert');
      
      if (currentCount <= DAILY_LIMIT) {
        // 未超过限制时的提示
        reminderEl.textContent = `24小时内此IP可使用${DAILY_LIMIT}次，已使用${currentCount}次`;
        reminderEl.style.display = 'block';
        limitAlertEl.style.display = 'none';
      } else {
        // 超过限制时的提示
        limitAlertEl.textContent = `24小时内此IP只能使用${DAILY_LIMIT}次，已使用${currentCount}次，不计入有效`;
        limitAlertEl.style.display = 'block';
        reminderEl.style.display = 'none';
      }
    }

    // 检查视频是否合格（只有在限制内才计入有效）
    function checkQualified(videoId) {
      return isWithinLimit && videoRecords[videoId].watchSeconds >= REQUIRED_SECONDS;
    }

    // 检测视频是否在播放（通过时间差判断）
    function checkVideoPlaying() {
      const now = Date.now(); // 当前时间戳
      
      // 如果是第一次检测，初始化基准时间
      if (lastKnownTime === 0) {
        lastKnownTime = now;
        return;
      }
      
      // 计算时间差（正常播放时，视频内部时间会随系统时间推进）
      const timeDiff = now - lastKnownTime;
      
      // 如果时间差超过900ms（允许一定误差），说明视频在播放（时间在推进）
      if (timeDiff > 900) {
        timeProgressCount++;
        lastKnownTime = now;
        
        // 连续3次检测到时间推进，判定为正在播放
        if (timeProgressCount >= 3 && !isVideoPlaying) {
          isVideoPlaying = true;
          startTracking();
          document.getElementById('manualHint').style.display = 'none';
          console.log('检测到视频播放，启动计时');
        }
      } else {
        // 时间未推进，重置计数
        timeProgressCount = 0;
        isVideoPlaying = false;
        document.getElementById('manualHint').style.display = 'block';
      }
    }

    // 手动开始计时（备用方案）
    function manualStartTracking() {
      isVideoPlaying = true;
      startTracking();
      document.getElementById('manualHint').style.display = 'none';
      alert(isWithinLimit ? '已手动开始计时，将记录观看时长' : '已手动开始计时，但本次不计入有效次数');
    }

    // 加载并播放选中的视频
    async function loadSelectedVideo() {
      if (currentVideoId) {
        clearInterval(timer);
      }
      clearInterval(playCheckInterval);
      
      // 重置检测参数
      lastKnownTime = 0;
      timeProgressCount = 0;
      isVideoPlaying = false;

      const selector = document.getElementById('videoSelector');
      currentVideoUrl = selector.value;
      currentVideoId = selector.options[selector.selectedIndex].dataset.id;
      const videoName = selector.options[selector.selectedIndex].text;

      if (!videoRecords[currentVideoId]) {
        videoRecords[currentVideoId] = {
          name: videoName,
          watchSeconds: 0,
          isQualified: false,
          totalSeconds: 0,
          isEffective: true // 标记是否为有效次数内的观看
        };
      }
      
      // 更新是否有效状态
      videoRecords[currentVideoId].isEffective = isWithinLimit;

      const videoFrame = document.getElementById('videoFrame');
      videoFrame.src = currentVideoUrl;
      
      // 启动时间差检测（每1秒检测一次）
      playCheckInterval = setInterval(checkVideoPlaying, 1000);

      // 显示初始状态
      document.getElementById('progressDisplay').textContent = "等待视频播放中...";
      document.getElementById('durationAlert').style.display = 'none';
      document.getElementById('manualHint').style.display = 'none';
      updateHistoryDisplay();

      // 上报视频切换事件
      gtag('event', 'video_switch', {
        'event_category': 'video',
        'event_label': currentVideoId,
        'video_url': currentVideoUrl,
        'ip': userIp,
        'previous_watch_seconds': videoRecords[currentVideoId].watchSeconds,
        'ip_usage_count': getIpUsageCount(),
        'is_within_limit': isWithinLimit
      });
    }

    // 更新进度显示
    function updateProgressDisplay() {
      if (!isVideoPlaying) return;
      
      const record = videoRecords[currentVideoId];
      let progressText = `已观看: ${record.watchSeconds}秒 / 需观看: 120秒`;
      
      // 如果超过限制，提示不计入有效
      if (!isWithinLimit) {
        progressText += '（本次观看不计入有效）';
      }
      
      document.getElementById('progressDisplay').textContent = progressText;
      document.getElementById('durationAlert').style.display = record.isQualified ? 'block' : 'none';
    }

    // 更新历史记录显示
    function updateHistoryDisplay() {
      let historyHtml = '观看记录：';
      let hasRecords = false;
      
      Object.values(videoRecords).forEach(record => {
        hasRecords = true;
        let status = record.isQualified ? '✅ 已合格' : `⏱️ 已看${record.watchSeconds}秒`;
        // 标记是否有效
        if (!record.isEffective) {
          status += '（不计入有效）';
        }
        historyHtml += `<br>${record.name}: ${status}`;
      });
      
      if (!hasRecords) historyHtml += '暂无';
      document.getElementById('videoHistory').innerHTML = historyHtml;
    }

    async function startWatching() {
      userIp = await getIp();
      incrementIpUsage(); // 先更新计数和限制状态
      
      document.getElementById('videoContainer').style.display = 'block';
      await loadSelectedVideo();

      gtag('event', 'video_start', {
        'event_category': 'video',
        'event_label': currentVideoId,
        'video_url': currentVideoUrl,
        'ip': userIp,
        'previous_watch_seconds': videoRecords[currentVideoId].watchSeconds,
        'ip_usage_count': getIpUsageCount(),
        'is_within_limit': isWithinLimit
      });
    }

    function startTracking() {
      if (timer) clearInterval(timer);
      
      timer = setInterval(() => {
        if (isVideoPlaying) {
          videoRecords[currentVideoId].watchSeconds++;
          
          // 检查是否合格（只有在限制内才会标记合格）
          if (!videoRecords[currentVideoId].isQualified && checkQualified(currentVideoId)) {
            videoRecords[currentVideoId].isQualified = true;
            gtag('event', 'video_qualified', {
              'event_category': 'video',
              'event_label': currentVideoId,
              'value': videoRecords[currentVideoId].watchSeconds,
              'video_url': currentVideoUrl,
              'ip': userIp,
              'is_within_limit': isWithinLimit
            });
          }

          updateProgressDisplay();
          updateHistoryDisplay();

          if (videoRecords[currentVideoId].watchSeconds % 10 === 0) {
            gtag('event', 'video_progress', {
              'event_category': 'video',
              'event_label': currentVideoId,
              'value': videoRecords[currentVideoId].watchSeconds,
              'video_url': currentVideoUrl,
              'ip': userIp,
              'is_within_limit': isWithinLimit
            });
          }
        }
      }, 1000);
    }

    // 页面关闭时清理
    window.addEventListener("beforeunload", () => {
      Object.keys(videoRecords).forEach(videoId => {
        const record = videoRecords[videoId];
        gtag('event', 'video_end', {
          'event_category': 'video',
          'event_label': videoId,
          'value': record.watchSeconds,
          'is_qualified': record.isQualified,
          'ip': userIp,
          'ip_usage_count': getIpUsageCount(),
          'is_within_limit': isWithinLimit
        });
      });
      clearInterval(timer);
      clearInterval(playCheckInterval);
    });

    document.getElementById('videoSelector').addEventListener('change', loadSelectedVideo);
  </script>
</body>
</html>
    
