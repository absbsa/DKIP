<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- 保留你的GA配置 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X0ZSRRF93P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-X0ZSRRF93P');
  </script>

  <style>
    /* 完全保留你的原有样式 */
    .video-container { position: relative; }
    .interaction-hint {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); color: white;
      display: flex; align-items: center; justify-content: center;
      z-index: 10; cursor: pointer;
    }
    body {
      margin: 0; padding: 20px; min-height: 100vh;
      background: #111; color: white; font-family: Arial, sans-serif;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .video-container { width: 100%; height: 70vh; margin-top: 20px; display: none; }
    iframe { width: 100%; height: 100%; border: none; }
    .video-selector { margin: 20px 0; padding: 20px; background: #222; border-radius: 10px; text-align: center; }
    button { padding: 12px 24px; background: #1DA1F2; color: white; border: none; border-radius: 30px; font-size: 16px; cursor: pointer; margin-top: 10px; }
    button:hover { background: #0d8bd9; }
    .rule-note { font-size: 14px; color: #ffd700; margin-top: 5px; line-height: 1.6; white-space: pre-line; }
    .duration-alert { color: #4CAF50; margin-top: 10px; display: none; }
    .progress-display { color: #fff; margin-top: 10px; font-size: 14px; }
    .video-history { margin-top: 15px; padding: 10px; background: #333; border-radius: 5px; font-size: 13px; text-align: left; }
    .ip-reminder { color: #ff9800; margin-top: 10px; font-size: 14px; display: none; }
    .ip-limit-alert { color: #ff4444; margin-top: 10px; font-size: 14px; display: none; }
    .manual-start提示 { color: #ff4444; margin-top: 10px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- 完全保留你的原有界面结构 -->
    <div class="video-selector">
      <h3>选择视频</h3>
      <select id="videoSelector">
        <option value="https://mivalyo.com/embed/6suaa9gg9y7y" data-id="video1">黄霄雲 1</option>
        <option value="https://mivalyo.com/embed/649eym1t2485" data-id="video2">黄霄雲 2</option>
        <option value="https://mivalyo.com/embed/third-video-id" data-id="video3">视频 3</option>
      </select>
      <p class="rule-note">点击视频开始按钮，连续点击直至无广告弹出，不能屏蔽广告，弹出后不管，看完视频后关闭浏览器，
        如点击开始后视频直接播放未弹出广告，连续点击播放视频页面直至能看到视频进度条为止，
        每个视频观看满 120 秒才算合格</p>
      <button onclick="startWatching()">开始观看</button>
      <button onclick="manualStartTracking()" style="background:#ff4444; margin-left:10px;">手动开始计时</button>
      <p class="ip-reminder" id="ipReminder"></p>
      <p class="ip-limit-alert" id="ipLimitAlert"></p>
      <div class="video-history" id="videoHistory">观看记录：暂无</div>
    </div>

    <div class="video-container" id="videoContainer">
      <div class="interaction-hint" id="interactionHint">点击视频区域开始播放并启动计时</div>
      <p class="progress-display" id="progressDisplay">等待视频播放中...</p>
      <p class="duration-alert" id="durationAlert">已达到有效观看时长（120秒）</p>
      <p class="manual-start提示" id="manualHint" style="display:none;">系统未检测到视频播放，可点击"手动开始计时"</p>
      <iframe id="videoFrame" allowfullscreen></iframe>
    </div>
  </div>

  <script>
    let timer = null;
    let playCheckInterval = null;
    let lastKnownTime = 0;
    let timeProgressCount = 0;
    let currentVideoId = '';
    let currentVideoUrl = '';
    let userIp = '';
    let isVideoPlaying = false;
    let isWithinLimit = true;
    let userInteracted = false;
    const REQUIRED_SECONDS = 120;
    const IP_USAGE_KEY = 'ipDailyUsageCount';
    const DAILY_LIMIT = 2;
    let videoRecords = {};

    // 完全保留你的原有函数（获取IP、IP次数管理等）
    async function getIp() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        console.error('获取IP失败:', error);
        return 'unknown-ip';
      }
    }

    function checkAndResetDailyCount(ipData) {
      const now = new Date().getTime();
      const oneDay = 24 * 60 * 60 * 1000;
      if (!ipData.lastReset || now - ipData.lastReset > oneDay) {
        ipData.count = 0;
        ipData.lastReset = now;
      }
      return ipData;
    }

    function getIpUsageCount() {
      const now = new Date().getTime();
      const ipDataStr = localStorage.getItem(IP_USAGE_KEY) || '{}';
      let ipData = JSON.parse(ipDataStr);
      if (!ipData[userIp]) {
        ipData[userIp] = { count: 0, lastReset: now };
      }
      ipData[userIp] = checkAndResetDailyCount(ipData[userIp]);
      localStorage.setItem(IP_USAGE_KEY, JSON.stringify(ipData));
      return ipData[userIp].count;
    }

    function incrementIpUsage() {
      const now = new Date().getTime();
      const ipDataStr = localStorage.getItem(IP_USAGE_KEY) || '{}';
      let ipData = JSON.parse(ipDataStr);
      if (!ipData[userIp]) {
        ipData[userIp] = { count: 0, lastReset: now };
      }
      ipData[userIp] = checkAndResetDailyCount(ipData[userIp]);
      ipData[userIp].count++;
      localStorage.setItem(IP_USAGE_KEY, JSON.stringify(ipData));
      const currentCount = ipData[userIp].count;
      isWithinLimit = currentCount <= DAILY_LIMIT;
      const reminderEl = document.getElementById('ipReminder');
      const limitAlertEl = document.getElementById('ipLimitAlert');
      if (currentCount <= DAILY_LIMIT) {
        reminderEl.textContent = `24小时内此IP可使用${DAILY_LIMIT}次，已使用${currentCount}次`;
        reminderEl.style.display = 'block';
        limitAlertEl.style.display = 'none';
      } else {
        limitAlertEl.textContent = `24小时内此IP只能使用${DAILY_LIMIT}次，已使用${currentCount}次，不计入有效`;
        limitAlertEl.style.display = 'block';
        reminderEl.style.display = 'none';
      }
    }

    function checkQualified(videoId) {
      return isWithinLimit && videoRecords[videoId].watchSeconds >= REQUIRED_SECONDS;
    }

    // 仅修复此处：解决暂停仍计时的问题
    function checkVideoPlaying() {
      if (!userInteracted) {
        if (isVideoPlaying) {
          isVideoPlaying = false;
          clearInterval(timer); // 未交互时停止计时
          timer = null; // 彻底清空定时器
          document.getElementById('manualHint').style.display = 'block';
        }
        return;
      }

      const now = Date.now();
      const timeDiff = now - lastKnownTime;

      // 播放时启动计时
      if (timeDiff > 1000) { // 降低阈值，更容易检测到播放
        timeProgressCount++;
        lastKnownTime = now;
        if (timeProgressCount >= 2 && !isVideoPlaying) { // 减少连续检测次数
          isVideoPlaying = true;
          startTracking();
          document.getElementById('manualHint').style.display = 'none';
        }
      } else {
        // 暂停时彻底停止计时（核心修复）
        timeProgressCount = 0;
        if (isVideoPlaying) {
          isVideoPlaying = false;
          clearInterval(timer); // 强制清除定时器
          timer = null; // 确保定时器为空
          document.getElementById('manualHint').style.display = 'block';
        }
      }
    }

    // 完全保留你的其他函数（手动计时、加载视频等）
    function manualStartTracking() {
      userInteracted = true;
      document.getElementById('interactionHint').style.display = 'none';
      isVideoPlaying = true;
      startTracking();
      document.getElementById('manualHint').style.display = 'none';
      alert(isWithinLimit ? '已手动开始计时，将记录观看时长' : '已手动开始计时，但本次不计入有效次数');
    }

    async function loadSelectedVideo() {
      if (currentVideoId) clearInterval(timer);
      clearInterval(playCheckInterval);
      
      lastKnownTime = 0;
      timeProgressCount = 0;
      isVideoPlaying = false;
      userInteracted = false;
      document.getElementById('interactionHint').style.display = 'flex';

      const selector = document.getElementById('videoSelector');
      currentVideoUrl = selector.value;
      currentVideoId = selector.options[selector.selectedIndex].dataset.id;
      const videoName = selector.options[selector.selectedIndex].text;

      if (!videoRecords[currentVideoId]) {
        videoRecords[currentVideoId] = {
          name: videoName,
          watchSeconds: 0,
          isQualified: false,
          totalSeconds: 0,
          isEffective: true
        };
      }
      videoRecords[currentVideoId].isEffective = isWithinLimit;

      const videoFrame = document.getElementById('videoFrame');
      videoFrame.src = currentVideoUrl;
      
      playCheckInterval = setInterval(checkVideoPlaying, 500);

      document.getElementById('progressDisplay').textContent = "等待视频播放中...";
      document.getElementById('durationAlert').style.display = 'none';
      document.getElementById('manualHint').style.display = 'none';
      updateHistoryDisplay();

      gtag('event', 'video_switch', {
        'event_category': 'video',
        'event_label': currentVideoId,
        'video_url': currentVideoUrl,
        'ip': userIp,
        'previous_watch_seconds': videoRecords[currentVideoId].watchSeconds,
        'ip_usage_count': getIpUsageCount(),
        'is_within_limit': isWithinLimit
      });
    }

    function updateProgressDisplay() {
      if (!isVideoPlaying) return;
      const record = videoRecords[currentVideoId];
      let progressText = `已观看: ${record.watchSeconds}秒 / 需观看: 120秒`;
      if (!isWithinLimit) progressText += '（本次观看不计入有效）';
      document.getElementById('progressDisplay').textContent = progressText;
      document.getElementById('durationAlert').style.display = record.isQualified ? 'block' : 'none';
    }

    function updateHistoryDisplay() {
      let historyHtml = '观看记录：';
      let hasRecords = false;
      Object.values(videoRecords).forEach(record => {
        hasRecords = true;
        let status = record.isQualified ? '✅ 已合格' : `⏱️ 已看${record.watchSeconds}秒`;
        if (!record.isEffective) status += '（不计入有效）';
        historyHtml += `<br>${record.name}: ${status}`;
      });
      if (!hasRecords) historyHtml += '暂无';
      document.getElementById('videoHistory').innerHTML = historyHtml;
    }

    async function startWatching() {
      userIp = await getIp();
      incrementIpUsage();
      document.getElementById('videoContainer').style.display = 'block';
      await loadSelectedVideo();
      gtag('event', 'video_start', {
        'event_category': 'video',
        'event_label': currentVideoId,
        'video_url': currentVideoUrl,
        'ip': userIp,
        'previous_watch_seconds': videoRecords[currentVideoId].watchSeconds,
        'ip_usage_count': getIpUsageCount(),
        'is_within_limit': isWithinLimit
      });
    }

    function startTracking() {
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        if (isVideoPlaying) {
          videoRecords[currentVideoId].watchSeconds++;
          if (!videoRecords[currentVideoId].isQualified && checkQualified(currentVideoId)) {
            videoRecords[currentVideoId].isQualified = true;
            gtag('event', 'video_qualified', {
              'event_category': 'video',
              'event_label': currentVideoId,
              'value': videoRecords[currentVideoId].watchSeconds,
              'video_url': currentVideoUrl,
              'ip': userIp,
              'is_within_limit': isWithinLimit
            });
          }
          updateProgressDisplay();
          updateHistoryDisplay();
          if (videoRecords[currentVideoId].watchSeconds % 10 === 0) {
            gtag('event', 'video_progress', {
              'event_category': 'video',
              'event_label': currentVideoId,
              'value': videoRecords[currentVideoId].watchSeconds,
              'video_url': currentVideoUrl,
              'ip': userIp,
              'is_within_limit': isWithinLimit
            });
          }
        }
      }, 1000);
    }

    window.addEventListener("beforeunload", () => {
      Object.keys(videoRecords).forEach(videoId => {
        const record = videoRecords[videoId];
        gtag('event', 'video_end', {
          'event_category': 'video',
          'event_label': videoId,
          'value': record.watchSeconds,
          'is_qualified': record.isQualified,
          'ip': userIp,
          'ip_usage_count': getIpUsageCount(),
          'is_within_limit': isWithinLimit
        });
      });
      clearInterval(timer);
      clearInterval(playCheckInterval);
    });

    document.getElementById('interactionHint').addEventListener('click', function() {
      userInteracted = true;
      this.style.display = 'none';
      lastKnownTime = Date.now();
    });

    document.getElementById('videoSelector').addEventListener('change', loadSelectedVideo);
  </script>
</body>
</html>
