<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>视频观看任务</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      font-family: "微软雅黑", sans-serif;
    }
    body {
      background: #1E1E1E; 
      color: #fff; 
      text-align: center; 
      padding: 50px 20px;
    }
    .container {
      max-width: 600px; 
      margin: 0 auto; 
      background: #2C2C2C; 
      border-radius: 12px; 
      padding: 30px;
    }
    h2 {
      font-size: 24px; 
      margin-bottom: 20px;
    }
    .video-select {
      margin: 20px 0;
    }
    select {
      padding: 8px 12px; 
      font-size: 16px; 
      border-radius: 6px; 
      border: none; 
      background: #3A3A3A; 
      color: #fff;
    }
    .rule {
      font-size: 14px; 
      line-height: 1.6; 
      color: #FFD700; 
      margin: 10px 0; 
      text-align: left;
    }
    .btn-group {
      display: flex; 
      justify-content: center; 
      gap: 20px; 
      margin: 30px 0;
    }
    button {
      padding: 12px 30px; 
      font-size: 16px; 
      border-radius: 25px; 
      border: none; 
      cursor: pointer; 
      transition: all 0.3s;
    }
    .start-btn {
      background: #1DA1F2; 
      color: #fff;
    }
    .start-btn:hover {
      background: #0D8BD9;
    }
    .manual-btn {
      background: #FF4444; 
      color: #fff;
    }
    .manual-btn:hover {
      background: #E63939;
    }
    .ip-info {
      color: #FF4444; 
      margin: 10px 0; 
      font-size: 14px;
    }
    .status {
      font-size: 14px; 
      margin: 20px 0; 
      min-height: 30px;
    }
    .video-box {
      width: 100%; 
      height: 360px; 
      margin-top: 30px; 
      display: none; 
      position: relative;
    }
    .video-cover {
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.6); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: #fff; 
      font-size: 18px; 
      cursor: pointer; 
      z-index: 99;
    }
    iframe {
      width: 100%; 
      height: 100%; 
      border: none; 
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>选择视频</h2>
    <div class="video-select">
      <select id="videoSelector">
        <option value="https://mivalyo.com/embed/6suaa9gg9y7y" data-id="video1">黄霄雲 1</option>
        <option value="https://mivalyo.com/embed/649eym1t2485" data-id="video2">黄霄雲 2</option>
        <option value="https://mivalyo.com/embed/third-video-id" data-id="video3">视频 3</option>
      </select>
    </div>
    <div class="rule">
      点击视频开始按钮，连续点击直至无广告弹出，不能屏蔽广告，弹出后不管，看完视频后关闭浏览器<br>
      如点击开始后视频直接播放未弹出广告，连续点击播放视频页面直至能看到视频进度条为止<br>
      每个视频观看满 <span style="color: #4CAF50;">120 秒</span> 才算合格
    </div>
    <div class="btn-group">
      <button class="start-btn" onclick="startWatching()">开始观看</button>
      <button class="manual-btn" onclick="manualStart()">手动开始计时</button>
    </div>
    <div class="ip-info" id="ipLimitInfo"></div>
    <div class="status" id="statusText">视频加载中...</div>
    <div class="video-box" id="videoContainer">
      <div class="video-cover" id="videoCover">点击视频区域开始播放并启动计时</div>
      <iframe id="videoFrame" allowfullscreen></iframe>
    </div>
  </div>

  <script>
    // 核心变量
    let timer = null;          // 计时定时器
    let videoUrl = '';         // 当前视频地址
    let videoId = '';          // 当前视频ID
    let userIp = '';           // 用户IP
    let watchSeconds = 0;      // 已观看时长（秒）
    let isTracking = false;    // 是否正在计时
    let isQualified = false;   // 是否达标
    let ipDailyCount = 0;      // IP当日使用次数
    const DAILY_LIMIT = 2;     // 每日IP限制次数

    // 获取用户IP（使用国内可访问的API）
    async function getIp() {
      try {
        const res = await fetch('https://api.ip.sb/jsonip');
        const data = await res.json();
        return data.ip;
      } catch (err) {
        console.error('获取IP失败:', err);
        return 'unknown-ip';
      }
    }

    // 检查IP使用次数
    function checkIpLimit() {
      const ipData = localStorage.getItem('ipWatchLimit') || '{"count":0,"lastReset":0}';
      const { count, lastReset } = JSON.parse(ipData);
      const now = Date.now();
      // 每天0点重置次数
      if (now - lastReset > 24 * 60 * 60 * 1000) {
        localStorage.setItem('ipWatchLimit', JSON.stringify({ count: 0, lastReset: now }));
        return 0;
      }
      return count;
    }

    // 增加IP使用次数
    function incrementIpCount() {
      const ipData = localStorage.getItem('ipWatchLimit') || '{"count":0,"lastReset":0}';
      const { count, lastReset } = JSON.parse(ipData);
      const now = Date.now();
      let newCount = count;
      // 每天0点重置
      if (now - lastReset > 24 * 60 * 60 * 1000) {
        newCount = 1;
        localStorage.setItem('ipWatchLimit', JSON.stringify({ count: newCount, lastReset: now }));
      } else {
        newCount = count + 1;
        localStorage.setItem('ipWatchLimit', JSON.stringify({ count: newCount, lastReset: lastReset }));
      }
      return newCount;
    }

    // 启动观看流程
    async function startWatching() {
      // 获取IP和次数
      userIp = await getIp();
      ipDailyCount = checkIpLimit();
      
      // 检查IP限制
      if (ipDailyCount >= DAILY_LIMIT) {
        document.getElementById('ipLimitInfo').innerText = `24小时内此IP只能使用${DAILY_LIMIT}次，已使用${ipDailyCount}次，不计入有效`;
        return;
      }

      // 加载视频
      const selector = document.getElementById('videoSelector');
      videoUrl = selector.value;
      videoId = selector.options[selector.selectedIndex].dataset.id;
      document.getElementById('videoContainer').style.display = 'block';
      document.getElementById('statusText').innerText = '视频准备中...';
      document.getElementById('videoFrame').src = videoUrl;
      
      // 绑定视频覆盖层点击事件
      document.getElementById('videoCover').addEventListener('click', function() {
        this.style.display = 'none';
        startTrackingTime(); // 点击后开始计时
      });
    }

    // 开始计时逻辑（核心：仅在点击视频后触发）
    function startTrackingTime() {
      if (isTracking) return;
      isTracking = true;
      document.getElementById('statusText').innerText = '正在计时...';
      timer = setInterval(() => {
        watchSeconds++;
        // 检查是否达标
        if (watchSeconds >= 120 && !isQualified) {
          isQualified = true;
          document.getElementById('statusText').innerText = '已达到有效观看时长（120秒）';
          // 增加IP次数（达标时才计数）
          if (ipDailyCount < DAILY_LIMIT) {
            incrementIpCount();
          }
        }
        // 实时显示时长（可选）
        // document.getElementById('statusText').innerText = `已观看：${watchSeconds}秒`;
      }, 1000);
    }

    // 手动开始计时（备用方案）
    function manualStart() {
      if (isTracking) {
        alert('计时已启动，请勿重复操作');
        return;
      }
      isTracking = true;
      document.getElementById('videoCover').style.display = 'none';
      document.getElementById('statusText').innerText = '手动开始计时...';
      timer = setInterval(() => {
        watchSeconds++;
        if (watchSeconds >= 120 && !isQualified) {
          isQualified = true;
          document.getElementById('statusText').innerText = '已达到有效观看时长（120秒）';
          if (ipDailyCount < DAILY_LIMIT) {
            incrementIpCount();
          }
        }
      }, 1000);
    }

    // 页面关闭时清理
    window.addEventListener('beforeunload', () => {
      clearInterval(timer);
      // 可在此处上报数据到服务器
      console.log(`用户关闭页面，视频${videoId}观看时长：${watchSeconds}秒，是否达标：${isQualified}`);
    });

    // 初始化检查
    (async () => {
      userIp = await getIp();
      ipDailyCount = checkIpLimit();
      if (ipDailyCount >= DAILY_LIMIT) {
        document.getElementById('ipLimitInfo').innerText = `24小时内此IP只能使用${DAILY_LIMIT}次，已使用${ipDailyCount}次，不计入有效`;
      }
    })();
  </script>
</body>
</html>
