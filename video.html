<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- 原有头部代码不变 -->
</head>
<body>
  <div class="container">
    <!-- 原有页面结构不变 -->
  </div>

  <script>
    // 核心变量（原有变量不变）
    let timer = null;
    let watchSeconds = 0;
    let isTracking = false;
    let useCount = 0;
    let userIp = ''; 
    let currentUsername = ''; 
    const iframe = document.getElementById('videoFrame');
    const selector = document.getElementById('videoSelector');

    // 新增：后端服务地址（替换为你的 Render 公网地址）
    const backendUrl = 'https://video-backend-nmeq.onrender.com'; 

    // 获取IP（原有逻辑不变）
    async function getIp() { /* ... 保持不变 ... */ }

    // 次数管理（原有逻辑不变）
    function checkUseCount() { /* ... 保持不变 ... */ }
    function updateUseCount() { /* ... 保持不变 ... */ }

    // 启动任务（新增上报逻辑）
    async function startTask() {
      // 1. 输入用户名（原有逻辑不变）
      const username = prompt('请输入您的用户名（必填）：', '');
      if (!username || !username.trim()) {
        alert('用户名不能为空，请重新输入！');
        return;
      }
      currentUsername = username.trim(); 
      document.getElementById('usernameDisplay').innerText = `当前用户：${currentUsername}`;

      // 2. 校验视频选择（原有逻辑不变）
      const videoUrl = selector.value;
      if (!videoUrl.trim()) {
        alert('请选择有效视频');
        return;
      }

      // 3. 获取并提示使用次数（原有逻辑不变）
      useCount = checkUseCount();
      document.getElementById('ipAlert').innerText = `这是24小时内第${useCount + 1}次使用`;

      // 4. 初始化视频加载（原有逻辑不变）
      document.getElementById('statusText').innerText = '视频加载中...';
      iframe.style.display = 'block';
      iframe.src = videoUrl;

      // 5. 监听iframe加载状态（修改：达标后调用上报）
      iframe.onload = function() {
        document.getElementById('statusText').innerText = '视频加载完成，请点击播放开始计时';
        startTimer();
      };

      iframe.onerror = function() {
        document.getElementById('statusText').innerText = '视频加载失败，请重试';
      };
    }

    // 播放后启动计时（新增：达标后调用上报接口）
    function startTimer() {
      if (isTracking) return;
      isTracking = true;
      
      useCount = updateUseCount();
      document.getElementById('ipAlert').innerText = `这是24小时内第${useCount}次使用`;
      document.getElementById('statusText').innerText = '正在计时...（已观看：0秒）';
      
      timer = setInterval(() => {
        watchSeconds++;
        document.getElementById('statusText').innerText = `正在计时...（已观看：${watchSeconds}秒）`;
        
        if (watchSeconds >= 120) {
          clearInterval(timer);
          document.getElementById('statusText').innerText = '已达标！累计观看120秒';
          
          // 新增：调用后端接口上报数据
          reportToBackend(); 
        }
      }, 1000);
    }

    // 新增：对接后端接口的上报函数
    async function reportToBackend() {
      const data = {
        username: currentUsername,
        ip: userIp,
        videoUrl: selector.value,
        watchSeconds: watchSeconds
      };

      try {
        const res = await fetch(`${backendUrl}/api/report`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        if (result.success) {
          alert('数据上报成功！');
          console.log('上报结果：', result);
        } else {
          alert('数据上报失败，请重试');
          console.error('上报失败：', result);
        }
      } catch (error) {
        alert('网络错误，上报失败');
        console.error('上报异常：', error);
      }
    }

    // 页面关闭清理（原有逻辑不变）
    window.addEventListener('beforeunload', () => {
      clearInterval(timer);
    });

    // 初始化：获取IP并检查次数（原有逻辑不变）
    (async () => {
      userIp = await getIp();
      useCount = checkUseCount();
      document.getElementById('ipAlert').innerText = `这是24小时内第${useCount}次使用`;
    })();
  </script>
</body>
</html>
