<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Tracking with Earnvids API</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X0ZSRRF93P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-X0ZSRRF93P');
  </script>

  <style>
    body { background: #111; color: white; font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .video-selector { background: #222; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; }
    .video-container { width: 100%; height: 70vh; margin-top: 20px; }
    video { width: 100%; height: 100%; background: #000; }
    button { padding: 12px 24px; background: #1DA1F2; color: white; border: none; border-radius: 30px; cursor: pointer; margin: 10px; }
    .progress { margin: 10px 0; font-size: 16px; }
    .history { background: #333; padding: 10px; border-radius: 5px; text-align: left; margin-top: 15px; }
    .alert { color: #4CAF50; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <div class="video-selector">
      <h3>选择视频（通过 Earnvids API 加载）</h3>
      <select id="videoSelector">
        <option value="fb5asfuj2snh">视频 1（file_code: fb5asfuj2snh）</option>
        <option value="u9150wqzvhxj">视频 2（file_code: u9150wqzvhxj）</option>
      </select>
      <p>请先获取视频播放链接并开始播放</p>
      <button onclick="loadVideo()">加载视频</button>
      <div class="progress">
        已观看: <span id="watchTime">0</span>秒 / 需观看: 120秒
        <div id="qualifiedAlert" class="alert" style="display: none;">已达到有效观看时长！</div>
      </div>
      <div class="history" id="history">观看记录：暂无</div>
    </div>
    <div class="video-container">
      <video id="videoPlayer" controls>你的浏览器不支持 HTML5 视频</video>
    </div>
  </div>

  <script>
    // 配置 API 密钥（替换为你的 key）
    const API_KEY = "4263429idtqricctunz8";
    const REQUIRED_SECONDS = 120; // 有效观看时长
    let currentFileCode = "";
    let watchSeconds = 0;
    let timer = null;
    let videoRecords = {};
    let userIp = ""; // 后续可通过 ipify 获取

    // 获取用户 IP（用于 API 验证）
    async function getIp() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip;
      } catch (err) {
        console.error("获取 IP 失败:", err);
        return "127.0.0.1"; //  fallback
      }
    }

    // 1. 加载视频：通过 API 获取直接播放链接
    async function loadVideo() {
      currentFileCode = document.getElementById("videoSelector").value;
      userIp = await getIp();

      // 重置状态
      stopTracking();
      watchSeconds = 0;
      document.getElementById("watchTime").textContent = "0";
      document.getElementById("qualifiedAlert").style.display = "none";

      // 调用 API 获取视频直接播放链接（file/direct_link）
      try {
        const directLinkRes = await fetch(
          `https://earnvidsapi.com/api/file/direct_link?key=${API_KEY}&file_code=${currentFileCode}&ip=${userIp}`
        );
        const directLinkData = await directLinkRes.json();
        if (directLinkData.status !== 200) {
          alert("获取播放链接失败: " + directLinkData.msg);
          return;
        }

        // 调用 API 获取视频详情（file/info），验证视频时长
        const infoRes = await fetch(
          `https://earnvidsapi.com/api/file/info?key=${API_KEY}&file_code=${currentFileCode}`
        );
        const infoData = await infoRes.json();
        if (infoData.status !== 200) {
          alert("获取视频信息失败: " + infoData.msg);
          return;
        }
        const videoInfo = infoData.result[0];
        console.log("视频信息:", videoInfo);

        // 初始化记录
        if (!videoRecords[currentFileCode]) {
          videoRecords[currentFileCode] = {
            title: videoInfo.file_title || "未知视频",
            seconds: 0,
            qualified: false
          };
        }

        // 设置视频源并加载
        const videoPlayer = document.getElementById("videoPlayer");
        videoPlayer.src = directLinkData.result.hls_direct || directLinkData.result; // 优先 HLS 链接
        videoPlayer.load();

        // 监听视频播放事件，开始跟踪
        videoPlayer.addEventListener("play", startTracking);
        videoPlayer.addEventListener("pause", stopTracking);
        videoPlayer.addEventListener("ended", stopTracking);

      } catch (err) {
        console.error("加载视频失败:", err);
        alert("视频加载失败，请重试");
      }
    }

    // 2. 开始跟踪观看时长
    function startTracking() {
      if (timer) return;
      timer = setInterval(() => {
        watchSeconds++;
        document.getElementById("watchTime").textContent = watchSeconds;

        // 更新记录
        if (videoRecords[currentFileCode]) {
          videoRecords[currentFileCode].seconds = watchSeconds;
          // 验证是否达到有效时长
          if (watchSeconds >= REQUIRED_SECONDS && !videoRecords[currentFileCode].qualified) {
            videoRecords[currentFileCode].qualified = true;
            document.getElementById("qualifiedAlert").style.display = "block";
            // 可在此处调用 API 记录合格状态（如 account/stats）
            console.log("已达到有效观看时长，记录数据...");
          }
        }

        updateHistory();
      }, 1000);
    }

    // 3. 停止跟踪
    function stopTracking() {
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
    }

    // 更新观看记录
    function updateHistory() {
      let historyHtml = "观看记录：";
      let hasRecords = false;
      Object.values(videoRecords).forEach(record => {
        hasRecords = true;
        const status = record.qualified 
          ? "✅ 已合格" 
          : `⏱️ 已看${record.seconds}秒`;
        historyHtml += `<br>${record.title}: ${status}`;
      });
      document.getElementById("history").innerHTML = hasRecords ? historyHtml : "观看记录：暂无";
    }

    // 页面关闭时保存记录
    window.addEventListener("beforeunload", () => {
      stopTracking();
      // 可调用 API 同步最终观看数据到服务器（如 account/stats）
      console.log("页面关闭，同步记录:", videoRecords);
    });
  </script>
</body>
</html>
